<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oferta Finansowania - BAF</title>
    <link rel="icon" type="image/png" href="baf_logo_p.png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap');
        body { margin: 0; padding: 0; background-color: #f4f7f9; font-family: 'Lato', Arial, sans-serif; }
        
        #control-panel-left { position: fixed; top: 20px; left: 20px; width: 220px; background: #ffffff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); z-index: 1000; }
        .panel-btn { display: block; width: 100%; padding: 12px; margin-bottom: 8px; border: none; border-radius: 5px; cursor: pointer; font-size: 13px; font-weight: bold; text-align: center; transition: all 0.3s ease; background-color: #17a2b8; color: white; font-family: Arial, sans-serif; }
        .panel-btn:hover { background-color: #138496; }
        .panel-btn.copied { background-color: #28a745; }
        .back-link { display: block; text-align: center; margin-top: 10px; color: #555; text-decoration: none; font-size: 12px; }
        
        #email-content-wrapper { margin: 0 auto; padding: 20px 0 20px 260px; max-width: 1050px; }
        @media (max-width: 1200px) { #control-panel-left { position: relative; top: 0; left: 0; width: auto; margin: 20px; } #email-content-wrapper { padding: 0 20px; margin: 0; max-width: 100%; } }
    </style>
</head>
<body>

    <div id="control-panel-left">
        <button id="copy-button" class="panel-btn">Kopiuj całość do maila</button>
        <div style="font-size: 11px; color: #777; margin-top: 10px; text-align: center;">Kliknij, aby skopiować gotowy szablon.</div>
        <a href="generator_oferty.html" class="back-link">« Wróć do generatora</a>
    </div>

    <div id="email-content-wrapper">
        <table border="0" cellpadding="0" cellspacing="0" width="100%" style="font-family: 'Lato', Arial, sans-serif; background-color: #f4f7f9; color: #333333;">
            <tr>
                <td align="center" style="padding: 20px;">
                    <table border="0" cellpadding="0" cellspacing="0" width="100%" style="max-width: 1050px; background-color: #ffffff; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 30px rgba(0, 77, 153, 0.1); border: 1px solid #e1e4e8;">
                        <tr><td align="center" style="padding: 30px 0; background-color: #ffffff; border-bottom: 1px solid #f0f0f0;">
                            <a href="https://biuroanalizyfinansowej.pl/" target="_blank" style="text-decoration:none; border:0; outline:none;"><img src="baf_logo.png" alt="Biuro Analizy Finansowej" width="250" style="display: block; width: 250px; max-width: 100%; height: auto; border: 0;"></a>
                        </td></tr>
                        <tr>
                            <td style="padding: 40px 50px;">
                                <h1 id="client-greeting" style="color: #002d5a; font-size: 28px; margin: 0 0 25px 0; font-weight: 700; font-family: 'Lato', Arial, sans-serif;">Panie Kamilu,</h1>
                                <p id="intro-paragraph" style="font-size: 17px; color: #555555; margin-bottom: 25px; line-height: 1.6;"></p>

                                <div style="border-bottom: 1px solid #e0e0e0; padding-bottom: 30px; margin-bottom: 40px;">
                                    <h2 style="font-size: 24px; color: #004d99; border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-bottom: 25px; font-weight: 700; margin-top: 0;">Rodzaj Finansowania: <span id="financing-header">Kredyt firmowy ratalny</span></h2>

                                    <table border="0" cellpadding="0" cellspacing="0" width="100%">
                                        <tr id="variants-table-row">
                                            </tr>
                                    </table>
                                </div>

                                <div style="border-bottom: 1px solid #e0e0e0; padding-bottom: 30px; margin-bottom: 40px;">
                                    <h2 id="benefits-header" style="font-size: 24px; color: #004d99; border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-bottom: 25px; font-weight: 700; margin-top: 0;">Kluczowe Korzyści</h2>
                                    <div id="dynamic-benefits-container"></div>
                                </div>

                                <div id="fee-container" style="margin-bottom: 30px;">
                                    <h2 id="fee-header" style="font-size: 24px; color: #004d99; border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-bottom: 25px; font-weight: 700; margin-top: 0;">Wynagrodzenie za Doradztwo</h2>
                                    <div id="fee-details-container">
                                        </div>
                                </div>
                                
                                <p id="footer-text" style="font-size: 17px; color: #555; margin-top: 40px;">Czekam na <span id="client-decision-grammar">Pana</span> decyzję odnośnie wyboru wariantu, abyśmy mogli sprawnie przejść do procesowania wniosku.</p>

                                <div align="center" style="margin-top: 30px; margin-bottom: 30px;" id="advisor-card-container">
                                    <a id="advisor-link" href="#" style="display: inline-block; padding: 15px 35px; background-color: #17a2b8; color: #ffffff !important; text-decoration: none; font-weight: bold; border-radius: 5px; font-size: 18px; font-family: 'Lato', Arial, sans-serif;">Moja wizytówka</a>
                                </div>
                            </td>
                        </tr>
                    </table>
                </td>
            </tr>
        </table>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const storedData = localStorage.getItem('bafOfferData_V5_7');
            if (storedData) {
                const data = JSON.parse(storedData);
                const suffix = (data.vatType === 'VAT') ? '+ VAT' : 'zw. z VAT';

                // --- PODSTAWOWE DANE ---
                document.getElementById('client-greeting').textContent = data.clientName + ",";
                document.getElementById('intro-paragraph').innerHTML = data.introText.replace(/\n/g, '<br>');
                document.getElementById('financing-header').textContent = data.financingType;

                if (data.advisorLink) {
                    document.getElementById('advisor-link').href = data.advisorLink;
                } else {
                    document.getElementById('advisor-card-container').style.display = 'none';
                }

                if (data.customHeaders) {
                    if (data.customHeaders.benefits) document.getElementById('benefits-header').textContent = data.customHeaders.benefits;
                    if (data.customHeaders.fee) document.getElementById('fee-header').textContent = data.customHeaders.fee;
                }

                if (data.closingText) {
                    document.getElementById('footer-text').innerHTML = data.closingText;
                } else {
                    const genderClient = data.clientGender;
                    document.getElementById('client-decision-grammar').textContent = genderClient === 'F' ? "Pani" : "Pana";
                }

                // --- WARIANTY DYNAMICZNE ---
                const variantsRow = document.getElementById('variants-table-row');
                let variantsHTML = '';
                const vCount = data.variants.length;
                const colWidth = Math.floor(100 / vCount) - (vCount > 1 ? 2 : 0);

                data.variants.forEach((v, index) => {
                    const rowStyle = "padding: 8px 0; border-bottom: 1px solid #eee; color: #666;";
                    const valStyle = "padding: 8px 0; border-bottom: 1px solid #eee; font-weight: 700; color: #333;";
                    const dyspozycjaStyle = "padding: 8px 0; border-bottom: 1px solid #eee; font-weight: 700; color: #0056b3;";

                    variantsHTML += `
                    <td valign="top" width="${colWidth}%" style="background-color: #fdfdfd; border: 1px solid #dcebf7; border-top: 4px solid ${v.color}; border-radius: 8px; padding: 25px; box-shadow: 0 4px 15px rgba(0, 77, 153, 0.05);">
                        <h3 style="margin-top: 0; font-size: 20px; color: ${v.color}; text-align: center; margin-bottom: 20px; font-weight: 700;">${vCount === 1 ? 'OFERTA' : 'WARIANT ' + v.roman}</h3>
                        <table border="0" cellpadding="0" cellspacing="0" width="100%" style="font-size: 15px;">
                            ${v.visibility.brutto ? `<tr><td style="${rowStyle}">Kwota Brutto:</td><td align="right" style="${valStyle}">${v.brutto}</td></tr>` : ''}
                            ${v.visibility.netto ? `<tr><td style="${rowStyle}">Kwota Netto:</td><td align="right" style="${valStyle}">${v.netto}</td></tr>` : ''}
                            ${v.visibility.dyspozycja ? `<tr><td style="${rowStyle}">Kwota do dyspozycji:</td><td align="right" style="${dyspozycjaStyle}">${v.dyspozycja}</td></tr>` : ''}
                            ${v.visibility.okres ? `<tr><td style="${rowStyle}">Okres kredytowania:</td><td align="right" style="padding: 8px 0; border-bottom: 1px solid #eee; font-weight: 700; color: #004d99; font-size: 16px;">${v.months} mies.</td></tr>` : ''}
                            
                            ${v.visibility.prowizja ? `<tr><td style="${rowStyle}">Prowizja bankowa:</td><td align="right" style="${valStyle}">${v.prowizja}</td></tr>` : ''}
                            ${v.visibility.marza ? `<tr><td style="${rowStyle}">Marża banku:</td><td align="right" style="${valStyle}">${v.marza}</td></tr>` : ''}
                            ${v.visibility.wibor ? `<tr><td style="${rowStyle}">WIBOR:</td><td align="right" style="${valStyle}">${v.wibor}</td></tr>` : ''}
                            ${v.visibility.oproc ? `<tr><td style="padding: 10px 0; border-top: 1px solid #ddd; color: #666; font-weight: 700;">Oprocentowanie:</td><td align="right" style="padding: 10px 0; border-top: 1px solid #ddd; font-weight: 700; color: #333;">${v.oproc}</td></tr>` : ''}
                            ${v.visibility.koszt ? `<tr><td style="padding: 10px 0; border-top: 1px solid #ddd; color: #666; font-weight: 700;">Koszt Całkowity:</td><td align="right" style="padding: 10px 0; border-top: 1px solid #ddd; font-weight: 700; color: #28a745;">${v.koszt}</td></tr>` : ''}
                        </table>
                        
                        ${v.hasCondition ? `
                        <div style="font-size: 13px; color: #2e5c8a; background-color: #e8f4fd; padding: 12px; margin-top: 15px; border-radius: 4px; line-height: 1.5; border-left: 3px solid ${v.color};">
                            <strong>${v.condHeader}</strong><br>
                            ${v.condText.replace(/\n/g, '<br>')}
                        </div>` : ''}

                        ${v.hasBgk ? `
                        <div style="font-size: 13px; color: #004085; background-color: #cce5ff; padding: 12px; margin-top: 15px; border-radius: 4px; line-height: 1.5; border-left: 3px solid #0056b3;">
                            <strong>Gwarancja DE MINIMIS:</strong> W tym wariancie występuje Poręczenie BGK 0,5% od kwoty gwarancji (60% salda kredytu), płatne raz w roku przez 5 lat.
                        </div>` : ''}

                        <div style="background-color: #f0f7ff; border: 1px solid #cce5ff; border-radius: 6px; padding: 15px; margin-top: 20px; text-align: center;">
                            <span style="display: block; font-size: 22px; font-weight: 700; color: ${v.color}; margin-bottom: 5px;">${v.rata}</span>
                            <span style="font-size: 13px; color: #666;">Rata szacunkowa</span>
                        </div>
                    </td>`;

                    if (index < vCount - 1) {
                        variantsHTML += `<td width="2%"></td>`;
                    }
                });
                
                variantsRow.innerHTML = variantsHTML;

                // --- FEE SECTION ---
                if(!data.visibility.feeSection) {
                    document.getElementById('fee-container').style.display = 'none';
                } else {
                    const introTextFee = vCount > 1 
                        ? "Rozliczenie oparte o sukces (Success Fee). Wynagrodzenie płatne jest <strong>dopiero po uruchomieniu środków</strong>. W zależności od wybranego wariantu kwota ta wynosi:"
                        : "Rozliczenie oparte o sukces (Success Fee). Wynagrodzenie płatne jest <strong>dopiero po uruchomieniu środków</strong>. Kwota wynagrodzenia wynosi:";

                    let feeTableHTML = `
                    <div style="background-color: #f8faff; border-radius: 8px; padding: 25px; border: 1px solid #e0e9f5;">
                        <p style="font-size: 16px; color: #555; margin: 0 0 20px 0; line-height: 1.6;">${introTextFee}</p>
                        <table border="0" cellpadding="0" cellspacing="0" width="100%">
                            <tr>`;
                    
                    data.variants.forEach((v, index) => {
                        feeTableHTML += `
                        <td valign="center" width="${colWidth}%" style="background-color: #ffffff; border: 1px solid #dcebf7; border-top: 3px solid ${v.color}; border-radius: 6px; padding: 15px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.02);">
                            ${vCount > 1 ? `<div style="font-size: 16px; color: ${v.color}; font-weight: bold; margin-bottom: 8px;">Wariant ${v.roman}</div>` : ''}
                            <div style="font-size: 22px; font-weight: bold; color: #28a745;">${v.feeKwota} <span style="font-size: 14px; color: #555; font-weight: normal;">${suffix}</span></div>
                        </td>`;
                        
                        if (index < vCount - 1) {
                            feeTableHTML += `<td width="2%"></td>`;
                        }
                    });
                    
                    feeTableHTML += `</tr></table></div>`;
                    document.getElementById('fee-details-container').innerHTML = feeTableHTML;
                }

                // --- BENEFITS ---
                const benefitsContainer = document.getElementById('dynamic-benefits-container');
                let html = '<table border="0" cellpadding="0" cellspacing="0" width="100%">';
                const iconUrls = {
                    'wallet': 'https://img.icons8.com/ios/50/0056b3/wallet--v1.png',
                    'ok': 'https://img.icons8.com/ios/50/0056b3/ok--v1.png',
                    'checkbox': 'https://img.icons8.com/ios/50/0056b3/checked-checkbox--v1.png',
                    'unlock': 'https://img.icons8.com/ios/50/0056b3/unlock.png',
                    'discount': 'https://img.icons8.com/ios/50/0056b3/discount--v1.png',
                    'idea': 'https://img.icons8.com/ios/50/0056b3/idea.png',
                    'star': 'https://img.icons8.com/ios/50/0056b3/star.png',
                    'time': 'https://img.icons8.com/ios/50/0056b3/time.png',
                    'rocket': 'https://img.icons8.com/ios/50/0056b3/rocket.png',
                    'handshake': 'https://img.icons8.com/ios/50/0056b3/handshake.png',
                    'money': 'https://img.icons8.com/ios/50/0056b3/money-circulation.png'
                };
                data.benefits.forEach(ben => {
                    const iconSrc = iconUrls[ben.icon] || iconUrls['ok'];
                    html += `<tr><td valign="top" width="50" style="padding-bottom: 25px;"><img src="${iconSrc}" width="30" height="30" style="display: block;"></td><td valign="top" style="padding-bottom: 25px;"><div style="font-size: 17px; color: #555; line-height: 1.5;">${ben.text}</div></td></tr>`;
                });
                html += '</table>';
                benefitsContainer.innerHTML = html;
            }
        });

        document.getElementById('copy-button').addEventListener('click', function() {
            const btn = this;
            const emailWrapper = document.getElementById('email-content-wrapper');
            const range = document.createRange();
            range.selectNode(emailWrapper);
            window.getSelection().removeAllRanges();
            window.getSelection().addRange(range);
            try {
                const blob = new Blob([emailWrapper.innerHTML], { type: 'text/html' });
                const richTextInput = new ClipboardItem({ 'text/html': blob });
                navigator.clipboard.write([richTextInput]).then(() => successEffect(btn)).catch(() => { document.execCommand('copy'); successEffect(btn); });
            } catch (err) { document.execCommand('copy'); successEffect(btn); }
            window.getSelection().removeAllRanges();
        });

        function successEffect(btn) {
            const originalText = 'Kopiuj całość do maila'; const originalColor = '#17a2b8';
            btn.textContent = '✅ Skopiowano!'; btn.style.backgroundColor = '#28a745'; btn.classList.add('copied');
            setTimeout(() => { btn.textContent = originalText; btn.style.backgroundColor = originalColor; btn.classList.remove('copied'); }, 2000);
        }
    </script>
</body>
</html>
