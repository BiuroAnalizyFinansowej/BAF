<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generator Ofert BAF v3.0</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap');
        
        body { font-family: 'Lato', sans-serif; background: #f4f7f9; color: #333; padding: 20px; }
        .container { max-width: 950px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        
        h1, h2, h3 { color: #002d5a; margin-top: 0; }
        h2 { font-size: 1.1em; border-bottom: 2px solid #007bff; padding-bottom: 5px; margin-top: 25px; margin-bottom: 15px; }
        h3 { font-size: 1em; color: #555; margin-bottom: 10px; }

        .row { display: flex; gap: 20px; flex-wrap: wrap; align-items: flex-start; }
        .col { flex: 1; min-width: 250px; }
        
        .form-group { margin-bottom: 12px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 0.85em; color: #555; }
        input, select, textarea { 
            width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; 
            box-sizing: border-box; font-family: 'Lato', sans-serif; font-size: 14px;
        }
        input:focus, textarea:focus { border-color: #007bff; outline: none; }
        input[readonly] { background-color: #e9ecef; color: #495057; font-weight: bold; border-color: #ced4da; cursor: not-allowed; }

        /* Checkboxy */
        .toggle-section {
            background: #eef6ff; padding: 10px; border-radius: 6px; border: 1px solid #badce3; margin-bottom: 15px;
            display: flex; align-items: center; justify-content: space-between;
        }
        .toggle-section label { margin: 0; font-size: 1em; color: #004d99; cursor: pointer; display: flex; align-items: center; width: 100%; }
        .toggle-section input[type="checkbox"] { width: auto; transform: scale(1.5); margin-right: 15px; }

        /* Ikony */
        .icon-selector { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
        .icon-opt { 
            border: 2px solid #ddd; padding: 5px; border-radius: 5px; cursor: pointer; background: #fff;
            position: relative; transition: 0.2s; width: 32px; height: 32px;
        }
        .icon-opt:hover { border-color: #99caff; }
        .icon-opt.active { border-color: #007bff; background: #e6f7ff; box-shadow: 0 0 5px rgba(0,123,255,0.3); }
        .icon-opt.disabled { opacity: 0.3; pointer-events: none; border-color: #ccc; background: #eee; }
        .icon-opt img { width: 100%; height: 100%; display: block; }

        /* Lista dodanych korzyści */
        #addedBenefitsList { margin-top: 15px; }
        .added-benefit-item {
            background: #fff; border: 1px solid #ddd; padding: 8px 12px; margin-bottom: 5px; border-radius: 4px;
            display: flex; justify-content: space-between; align-items: center; font-size: 0.9em;
        }
        .added-benefit-item img { width: 20px; height: 20px; margin-right: 10px; vertical-align: middle; }
        .remove-ben-btn { color: #dc3545; cursor: pointer; font-weight: bold; font-size: 1.2em; margin-left: 10px; }

        /* Przyciski */
        button.generate-btn {
            background-color: #28a745; color: white; border: none; padding: 15px;
            width: 100%; font-size: 18px; font-weight: bold; border-radius: 8px;
            cursor: pointer; margin-top: 30px; transition: 0.3s;
        }
        button.generate-btn:hover { background-color: #218838; }

        .btn-small { padding: 5px 10px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .btn-add { background: #007bff; margin-top: 10px; width: 100%; padding: 10px; font-size: 14px; }
        .btn-add:hover { background: #0056b3; }
    </style>
</head>
<body>

<div class="container">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h1>Generator Oferty Finansowania</h1>
        <div style="text-align:right; font-size:0.8em; color:#777;">v3.0 Multi-Benefit</div>
    </div>

    <h2>1. Dane i Treść Wstępna</h2>
    <div class="row">
        <div class="col form-group">
            <label>Nagłówek (np. Panie Kamilu)</label>
            <input type="text" id="clientName" value="Panie Kamilu">
        </div>
        <div class="col form-group">
            <label>Płeć Klienta</label>
            <select id="clientGender">
                <option value="M">Mężczyzna</option>
                <option value="F">Kobieta</option>
            </select>
        </div>
        <div class="col form-group">
            <label>Doradca</label>
            <select id="advisor">
                <option value="Dawid Błachno|M">Dawid Błachno</option>
                <option value="Weronika Lekston|F">Weronika Lekston</option>
                <option value="Mieczysław Andrzejewski|M">Mieczysław Andrzejewski</option>
                <option value="Joanna Karpała|F">Joanna Karpała</option>
                <option value="Piotr Pakuła|M">Piotr Pakuła</option>
                <option value="Wiktoria Nojek|F">Wiktoria Nojek</option>
                <option value="Wojciech Młynarczyk|M">Wojciech Młynarczyk</option>
                <option value="Maja Zięba|F">Maja Zięba</option>
                <option value="Mateusz Dzidkowski|M">Mateusz Dzidkowski</option>
            </select>
        </div>
    </div>
    
    <div class="form-group">
        <label>Treść maila (Edytowalna, aktualizuje się po zmianie doradcy/płci)</label>
        <textarea id="introText" rows="4"></textarea>
    </div>

    <h2>2. Parametry Kredytu</h2>
    <div class="row" style="background: #fdfdfd; padding: 15px; border: 1px solid #eee; border-radius: 8px;">
        <div class="col form-group"><label>WIBOR 1M (%)</label><input type="number" step="0.01" id="wibor" value="4.02"></div>
        <div class="col form-group"><label>Okres (miesiące)</label><input type="number" id="months" value="120"></div>
        <div class="col form-group"><label>Kwota Netto (PLN)</label><input type="text" id="loanAmount" value="1000000"></div>
    </div>

    <div class="row" style="margin-top: 20px;">
        <div class="col" style="border-top: 4px solid #007bff; background: #fdfdfd; padding: 15px; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
            <h3 style="color: #0056b3;">Wariant I</h3>
            <div class="form-group"><label>Prowizja (%)</label><input type="number" step="0.01" id="w1_prowizja_proc" value="2.5"></div>
            <div class="form-group"><label>Marża (%)</label><input type="number" step="0.01" id="w1_marza" value="2.5"></div>
            <hr style="border-top: 1px solid #eee;">
            <div class="form-group"><label>Oprocentowanie</label><input type="text" id="w1_oproc_display" readonly></div>
            <div class="form-group"><label>Rata</label><input type="text" id="w1_rata_display" readonly style="color: #004d99; font-weight:bold;"></div>
            <div class="form-group"><label>Brutto</label><input type="text" id="w1_brutto_display" readonly></div>
        </div>

        <div class="col" id="col_variant2" style="border-top: 4px solid #28a745; background: #fdfdfd; padding: 15px; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 style="color: #28a745; margin:0;">Wariant II</h3>
                <label style="margin:0; font-size: 0.8em; display:flex; align-items:center; cursor:pointer;">
                    <input type="checkbox" id="enableVariant2" checked style="width:auto; margin-right:5px;"> Włączony
                </label>
            </div>
            <div id="w2_controls" style="margin-top: 15px;">
                <div class="form-group"><label>Prowizja (%)</label><input type="number" step="0.01" id="w2_prowizja_proc" value="0"></div>
                <div class="form-group"><label>Marża (%)</label><input type="number" step="0.01" id="w2_marza" value="2.5"></div>
                <hr style="border-top: 1px solid #eee;">
                <div class="form-group"><label>Oprocentowanie</label><input type="text" id="w2_oproc_display" readonly></div>
                <div class="form-group"><label>Rata</label><input type="text" id="w2_rata_display" readonly style="color: #28a745; font-weight:bold;"></div>
                <div class="form-group"><label>Brutto</label><input type="text" id="w2_brutto_display" readonly></div>
            </div>
        </div>
    </div>

    <h2>4. Wynagrodzenie i Opcje</h2>
    <div class="row">
        <div class="col form-group"><label>Success Fee (%)</label><input type="number" step="0.1" id="successFeeProc" value="4.0"></div>
        <div class="col form-group"><label>VAT</label><select id="vatType"><option value="VAT">+ VAT</option><option value="ZW">zw. z VAT</option></select></div>
        <div class="col form-group"><label>Kwota Fee</label><input type="text" id="successFeeKwota" readonly></div>
    </div>
    <div class="toggle-section"><label><input type="checkbox" id="showBGK" checked> Dodaj informację o Gwarancji BGK</label></div>

    <h2>5. Korzyści (Domyślne + Własne)</h2>
    
    <div id="defaultBenefits">
        <div class="toggle-section" style="background:white; border-color:#eee;">
            <label><input type="checkbox" id="ben1" checked data-icon="wallet" onchange="refreshIcons()"> BRAK OPŁAT KWARTALNYCH!</label>
        </div>
        <div class="toggle-section" style="background:white; border-color:#eee;">
            <label><input type="checkbox" id="ben2" checked data-icon="ok" onchange="refreshIcons()"> Przejrzyste warunki</label>
        </div>
        <div class="toggle-section" style="background:white; border-color:#eee;">
            <label><input type="checkbox" id="ben3" checked data-icon="unlock" onchange="refreshIcons()"> Pełna elastyczność (nadpłata 0%)</label>
        </div>
    </div>

    <div class="form-group" style="background: #f8faff; padding: 15px; border-radius: 6px; border: 1px solid #e1e4e8;">
        <label>Dodaj nową korzyść</label>
        <div style="display:flex; gap:10px;">
            <input type="text" id="customBenText" placeholder="Wpisz treść...">
            <button type="button" class="btn-small" onclick="insertBold()">Pogrubienie</button>
        </div>
        
        <div style="margin-top: 10px; font-size: 14px; color:#555;">Wybierz ikonę (Użyte są zablokowane):</div>
        <div class="icon-selector" id="iconSelector">
            </div>
        <input type="hidden" id="selectedCustomIcon" value="">

        <button type="button" class="btn-small btn-add" onclick="addCustomBenefit()">+ DODAJ KORZYŚĆ DO LISTY</button>
    </div>

    <div id="addedBenefitsList"></div>

    <button class="generate-btn" onclick="generateOffer()">GENERUJ OFERTĘ</button>
</div>

<script>
    // --- BAZA DANYCH ---
    const iconsDB = {
        'wallet': 'https://img.icons8.com/ios/50/0056b3/wallet--v1.png',
        'ok': 'https://img.icons8.com/ios/50/0056b3/ok--v1.png',
        'unlock': 'https://img.icons8.com/ios/50/0056b3/unlock.png',
        'discount': 'https://img.icons8.com/ios/50/0056b3/discount--v1.png',
        'idea': 'https://img.icons8.com/ios/50/0056b3/idea.png',
        'star': 'https://img.icons8.com/ios/50/0056b3/star.png',
        'time': 'https://img.icons8.com/ios/50/0056b3/time.png',
        'rocket': 'https://img.icons8.com/ios/50/0056b3/rocket.png',
        'handshake': 'https://img.icons8.com/ios/50/0056b3/handshake.png',
        'money': 'https://img.icons8.com/ios/50/0056b3/money-circulation.png'
    };

    let customBenefits = []; // Tablica na własne korzyści

    // --- FUNKCJE STARTOWE ---
    function initIcons() {
        const selector = document.getElementById('iconSelector');
        selector.innerHTML = '';
        for (const [key, url] of Object.entries(iconsDB)) {
            const div = document.createElement('div');
            div.className = 'icon-opt';
            div.dataset.icon = key;
            div.onclick = () => selectIcon(div);
            div.innerHTML = `<img src="${url}">`;
            selector.appendChild(div);
        }
    }

    function selectIcon(el) {
        if(el.classList.contains('disabled')) return;
        document.querySelectorAll('.icon-opt').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('selectedCustomIcon').value = el.dataset.icon;
    }

    function refreshIcons() {
        // 1. Zbierz użyte ikony (domyślne checkbox + customowe dodane)
        const usedIcons = new Set();
        
        // Domyślne
        document.querySelectorAll('#defaultBenefits input[type="checkbox"]').forEach(chk => {
            if(chk.checked) usedIcons.add(chk.dataset.icon);
        });

        // Customowe już dodane do listy
        customBenefits.forEach(ben => usedIcons.add(ben.icon));

        // 2. Aktualizuj UI ikon
        document.querySelectorAll('.icon-opt').forEach(opt => {
            const iconKey = opt.dataset.icon;
            if(usedIcons.has(iconKey)) {
                opt.classList.add('disabled');
                opt.classList.remove('active');
                // Jeśli zablokowaliśmy aktualnie wybraną, czyścimy wybór
                if(document.getElementById('selectedCustomIcon').value === iconKey) {
                    document.getElementById('selectedCustomIcon').value = '';
                }
            } else {
                opt.classList.remove('disabled');
            }
        });
    }

    // --- LOGIKA TEKSTU WSTĘPNEGO ---
    function updateIntroText() {
        const advVal = document.getElementById('advisor').value;
        const genderAdv = advVal.split('|')[1]; // M or F
        const clientVal = document.getElementById('clientName').value;
        
        let t_anal = genderAdv === 'F' ? 'Przeanalizowałam' : 'Przeanalizowałem';
        let t_prep = genderAdv === 'F' ? 'przygotowałam' : 'przygotowałem';
        let t_ment = genderAdv === 'F' ? 'wspominałam' : 'wspominałem';
        
        // Można tu dodać logikę dla "Pana/Pani" jeśli tekst tego wymaga, 
        // ale w podanym wzorze nie ma bezpośrednich zwrotów do klienta poza nagłówkiem.
        
        const text = `w nawiązaniu do rozmowy przesyłam kalkulacje propozycji finansowania. ${t_anal} dostępne możliwości i ${t_prep} ofertę kredytu firmowego ratalnego, o którym już ${t_ment} telefonicznie, w dwóch wariantach, różniących się strukturą kosztów początkowych.`;
        
        document.getElementById('introText').value = text;
    }

    // Listener na zmianę doradcy
    document.getElementById('advisor').addEventListener('change', updateIntroText);
    
    // --- LOGIKA WŁASNYCH KORZYŚCI ---
    function insertBold() {
        const input = document.getElementById('customBenText');
        const start = input.selectionStart;
        const end = input.selectionEnd;
        const text = input.value;
        const selectedText = text.substring(start, end);
        
        if (selectedText) {
            input.value = text.substring(0, start) + '<b>' + selectedText + '</b>' + text.substring(end);
        } else {
            input.value = text.substring(0, start) + '<b></b>' + text.substring(end);
        }
        input.focus();
    }

    function addCustomBenefit() {
        const text = document.getElementById('customBenText').value;
        const icon = document.getElementById('selectedCustomIcon').value;

        if(text.trim() === '') { alert('Wpisz treść korzyści.'); return; }
        if(icon === '') { alert('Wybierz dostępną ikonę.'); return; }

        // Domyślne pogrubienie, jeśli user nie użył tagów
        let finalText = text;
        if(!finalText.includes('<b>') && !finalText.includes('<strong>')) {
            finalText = '<strong>' + finalText + '</strong>';
        }

        // Dodaj do tablicy
        customBenefits.push({ text: finalText, icon: icon });

        // Renderuj listę
        renderCustomBenefits();
        
        // Reset formularza
        document.getElementById('customBenText').value = '';
        document.getElementById('selectedCustomIcon').value = '';
        document.querySelectorAll('.icon-opt').forEach(i => i.classList.remove('active'));
        
        // Odśwież blokady
        refreshIcons();
    }

    function removeCustomBenefit(index) {
        customBenefits.splice(index, 1);
        renderCustomBenefits();
        refreshIcons();
    }

    function renderCustomBenefits() {
        const list = document.getElementById('addedBenefitsList');
        list.innerHTML = '';
        customBenefits.forEach((ben, index) => {
            const div = document.createElement('div');
            div.className = 'added-benefit-item';
            div.innerHTML = `
                <div style="display:flex; align-items:center;">
                    <img src="${iconsDB[ben.icon]}">
                    <span>${ben.text}</span>
                </div>
                <span class="remove-ben-btn" onclick="removeCustomBenefit(${index})">&times;</span>
            `;
            list.appendChild(div);
        });
    }

    // --- KALKULATOR (SKRÓCONY Z POPRZEDNIEJ WERSJI) ---
    function parseMoney(val) { return parseFloat(val.toString().replace(/\s/g, '').replace('PLN','').replace(',','.')) || 0; }
    function formatMoney(num) { return num.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, ' ') + ' PLN'; }
    function calculatePMT(rate, periods, pv) {
        if (rate === 0) return pv / periods;
        const r = (rate / 100) / 12;
        return pv * r * Math.pow(1 + r, periods) / (Math.pow(1 + r, periods) - 1);
    }

    function updateCalculations() {
        const wibor = parseFloat(document.getElementById('wibor').value) || 0;
        const months = parseInt(document.getElementById('months').value) || 120;
        let loanNetto = parseMoney(document.getElementById('loanAmount').value);
        const successFeeProc = parseFloat(document.getElementById('successFeeProc').value) || 0;

        // W1
        const w1_p = parseFloat(document.getElementById('w1_prowizja_proc').value) || 0;
        const w1_m = parseFloat(document.getElementById('w1_marza').value) || 0;
        const w1_brutto = loanNetto * (1 + w1_p/100);
        const w1_rate = wibor + w1_m;
        const w1_rata = calculatePMT(w1_rate, months, w1_brutto);
        
        document.getElementById('w1_oproc_display').value = w1_rate.toFixed(2) + '%';
        document.getElementById('w1_brutto_display').value = formatMoney(w1_brutto);
        document.getElementById('w1_rata_display').value = formatMoney(w1_rata);

        // W2
        const isW2 = document.getElementById('enableVariant2').checked;
        if(isW2) {
            const w2_p = parseFloat(document.getElementById('w2_prowizja_proc').value) || 0;
            const w2_m = parseFloat(document.getElementById('w2_marza').value) || 0;
            const w2_brutto = loanNetto * (1 + w2_p/100);
            const w2_rate = wibor + w2_m;
            const w2_rata = calculatePMT(w2_rate, months, w2_brutto);
            
            document.getElementById('w2_oproc_display').value = w2_rate.toFixed(2) + '%';
            document.getElementById('w2_brutto_display').value = formatMoney(w2_brutto);
            document.getElementById('w2_rata_display').value = formatMoney(w2_rata);
            document.getElementById('w2_controls').style.opacity = '1';
        } else {
            document.getElementById('w2_controls').style.opacity = '0.5';
        }

        // Fee
        document.getElementById('successFeeKwota').value = formatMoney(loanNetto * (successFeeProc / 100));
    }

    // Listenery kalkulatora
    document.querySelectorAll('input, select').forEach(el => {
        if(el.id !== 'customBenText') el.addEventListener('input', updateCalculations);
    });
    document.getElementById('enableVariant2').addEventListener('change', updateCalculations);

    // --- GENEROWANIE JSON ---
    function generateOffer() {
        const data = {
            clientName: document.getElementById('clientName').value,
            clientGender: document.getElementById('clientGender').value,
            advisorData: document.getElementById('advisor').value,
            introText: document.getElementById('introText').value, // NOWE
            
            showBGK: document.getElementById('showBGK').checked,
            hasVariant2: document.getElementById('enableVariant2').checked,
            vatType: document.getElementById('vatType').value,
            months: document.getElementById('months').value,
            wibor: document.getElementById('wibor').value,

            w1: {
                netto: formatMoney(parseMoney(document.getElementById('loanAmount').value)),
                brutto: document.getElementById('w1_brutto_display').value,
                prowizja: document.getElementById('w1_prowizja_proc').value + '%',
                marza: document.getElementById('w1_marza').value + '%',
                oproc: document.getElementById('w1_oproc_display').value,
                rata: document.getElementById('w1_rata_display').value
            },
            w2: {
                netto: formatMoney(parseMoney(document.getElementById('loanAmount').value)),
                brutto: document.getElementById('w2_brutto_display').value,
                prowizja: document.getElementById('w2_prowizja_proc').value + '%',
                marza: document.getElementById('w2_marza').value + '%',
                oproc: document.getElementById('w2_oproc_display').value,
                rata: document.getElementById('w2_rata_display').value
            },
            feeProc: document.getElementById('successFeeProc').value + '%',
            feeKwota: document.getElementById('successFeeKwota').value,
            
            benefits: []
        };

        // Zbieranie domyślnych
        const defaultTexts = {
            'ben1': '<strong>BRAK OPŁAT KWARTALNYCH!</strong> Nie ma żadnych ukrytych kosztów za utrzymanie finansowania.',
            'ben2': '<strong>Przejrzyste warunki:</strong> Umowa bez "gwiazdek" i dodatkowych, nieoczekiwanych kosztów.',
            'ben3': '<strong>Pełna elastyczność:</strong> Całkowity brak opłat za nadpłatę oraz wcześniejszą całkowitą spłatę kredytu.'
        };
        
        ['ben1','ben2','ben3'].forEach(id => {
            if(document.getElementById(id).checked) {
                data.benefits.push({
                    text: defaultTexts[id],
                    icon: document.getElementById(id).dataset.icon
                });
            }
        });

        // Dodawanie własnych
        customBenefits.forEach(ben => data.benefits.push(ben));

        localStorage.setItem('bafOfferData_V3', JSON.stringify(data));
        window.location.href = 'oferta.html';
    }

    // INIT
    initIcons();
    updateIntroText(); // Generuje tekst na start
    updateCalculations();
    refreshIcons();
</script>

</body>
</html>
