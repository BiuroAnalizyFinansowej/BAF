<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generator Ofert BAF v5.4</title>
    <link rel="icon" type="image/png" href="baf_logo_p.png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap');
        
        body { font-family: 'Lato', sans-serif; background: #f4f7f9; color: #333; padding: 20px; margin: 0; }
        .layout-wrapper { display: flex; max-width: 1400px; margin: 0 auto; gap: 20px; align-items: flex-start; }
        .container { flex: 1; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow-x: auto; }
        .sidebar { width: 260px; flex-shrink: 0; position: sticky; top: 20px; }

        .info-container { background-color: #ffffff; color: #333; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #e1e4e8; }
        .info-header { font-size: 1.1em; font-weight: 700; color: #002d5a; border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-bottom: 15px; text-align: center; }
        .info-date { font-size: 0.85em; color: #777; text-align: center; margin-bottom: 15px; }
        .rates-grid { display: flex; flex-direction: column; gap: 12px; }
        .rate-item { display: flex; justify-content: space-between; align-items: center; font-size: 0.95em; border-bottom: 1px solid #f0f0f0; padding-bottom: 8px; }
        .rate-item:last-child { border-bottom: none; }
        .rate-item .value { font-weight: 700; color: #002d5a; font-size: 1.1em; }
        .info-container-single .value { text-align: center; font-size: 2em; font-weight: 700; color: #dc3545; margin: 10px 0; }
        .disclaimer-text { font-size: 0.7em; color: #999; text-align: center; margin-top: 15px; margin-bottom: 0; line-height: 1.4; }

        .top-nav { max-width: 1400px; margin: 0 auto 20px auto; display: flex; justify-content: space-between; align-items: center; }
        .nav-btn { text-decoration: none; color: #002d5a; font-weight: bold; border: 2px solid #002d5a; padding: 8px 15px; border-radius: 6px; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; font-size: 14px; background-color: transparent; }
        .nav-btn:hover { background-color: #002d5a; color: white; }
        .nav-btn svg { width: 20px; height: 20px; fill: currentColor; }

        h1, h2 { color: #002d5a; margin-top: 0; }
        h2 { font-size: 1.1em; border-bottom: 2px solid #007bff; padding-bottom: 5px; margin-top: 25px; margin-bottom: 15px; }
        .header-with-toggle { display: flex; align-items: center; justify-content: space-between; border-bottom: 2px solid #007bff; padding-bottom: 5px; margin-top: 25px; margin-bottom: 15px; }
        .header-with-toggle h2 { border: none; margin: 0; padding: 0; }

        .row { display: flex; gap: 20px; flex-wrap: nowrap; align-items: flex-start; overflow-x: auto; padding-bottom: 10px; }
        .col { flex: 1; min-width: 250px; }
        .form-group { margin-bottom: 12px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 0.85em; color: #555; }
        input[type="text"], input[type="number"], select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; font-family: 'Lato', sans-serif; font-size: 14px; }
        input:focus, textarea:focus { border-color: #007bff; outline: none; }
        input[readonly] { background-color: #e9ecef; color: #495057; font-weight: bold; cursor: not-allowed; }

        #financingType option.firmowe { background-color: #d1e7dd; color: #0f5132; }
        #financingType option.prywatne { background-color: #f8d7da; color: #842029; }
        
        .input-with-check { display: flex; align-items: center; gap: 8px; }
        .eye-checkbox { display: none; }
        .eye-label { cursor: pointer; font-size: 1.4em; user-select: none; transition: all 0.2s; line-height: 1; padding: 5px; border-radius: 4px; }
        .eye-checkbox:checked + .eye-label { opacity: 1; filter: none; }
        .eye-checkbox:checked + .eye-label::after { content: 'üëÅÔ∏è'; }
        .eye-checkbox:not(:checked) + .eye-label { opacity: 0.3; filter: grayscale(100%); }
        .eye-checkbox:not(:checked) + .eye-label::after { content: 'üëÅÔ∏è'; text-decoration: line-through; }

        .toggle-section { background: #eef6ff; padding: 10px; border-radius: 6px; border: 1px solid #badce3; margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between; }
        .toggle-section label { margin: 0; font-size: 1em; color: #004d99; cursor: pointer; display: flex; align-items: center; width: 100%; }
        .toggle-section input[type="checkbox"] { width: auto; margin-right: 15px; transform: scale(1.5); }

        .icon-selector { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
        .icon-opt { border: 2px solid #ddd; padding: 5px; border-radius: 5px; cursor: pointer; background: #fff; width: 32px; height: 32px; }
        .icon-opt.active { border-color: #007bff; background: #e6f7ff; }
        .icon-opt.disabled { opacity: 0.3; pointer-events: none; }
        .icon-opt img { width: 100%; height: 100%; display: block; }
        
        #addedBenefitsList { margin-top: 15px; }
        .added-benefit-item { background: #fff; border: 1px solid #ddd; padding: 8px 12px; margin-bottom: 5px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; font-size: 0.9em; }
        .added-benefit-item img { width: 20px; height: 20px; margin-right: 10px; }
        .remove-ben-btn { color: #dc3545; cursor: pointer; font-weight: bold; margin-left: 10px; }

        button.generate-btn { background-color: #28a745; color: white; border: none; padding: 15px; width: 100%; font-size: 18px; font-weight: bold; border-radius: 8px; cursor: pointer; transition: 0.3s; }
        button.generate-btn:hover { background-color: #218838; }
        .btn-add { background: #007bff; margin-top: 10px; width: 100%; padding: 10px; font-size: 14px; color: white; border: none; border-radius: 5px; cursor: pointer; transition: 0.3s; font-weight: bold; }
        .btn-add:hover { background: #0056b3; }
        .btn-remove-var { background: #dc3545; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 12px; font-weight: bold; }

        @media (max-width: 900px) { .layout-wrapper { flex-direction: column-reverse; } .sidebar { width: 100%; } .row { flex-wrap: wrap; } }
    </style>
</head>
<body>

<div class="top-nav">
    <a href="kalkulatory.html" class="nav-btn">&laquo; Wr√≥ƒá do Kalkulator√≥w</a>
    <a href="index.html" class="nav-btn" title="Strona G≈Ç√≥wna">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8h5z"/></svg> Strona G≈Ç√≥wna
    </a>
</div>

<div class="layout-wrapper">
    <div class="container">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h1>Generator Oferty</h1>
            <div style="text-align:right; font-size:0.8em; color:#777;">v5.4</div>
        </div>

        <h2>1. Dane i Wstƒôp</h2>
        <div class="row" style="flex-wrap: wrap;">
            <div class="col form-group"><label>Nag≈Ç√≥wek</label><input type="text" id="clientName" value="Panie Kamilu"></div>
            <div class="col form-group"><label>P≈Çeƒá</label><select id="clientGender"><option value="M">Mƒô≈ºczyzna</option><option value="F">Kobieta</option></select></div>
            <div class="col form-group">
                <label>Doradca</label>
                <select id="advisor">
                    <option value="Dawid B≈Çachno|M">Dawid B≈Çachno</option>
                    <option value="Weronika Lekston|F">Weronika Lekston</option>
                    <option value="Mieczys≈Çaw Andrzejewski|M">Mieczys≈Çaw Andrzejewski</option>
                    <option value="Joanna Karpa≈Ça|F">Joanna Karpa≈Ça</option>
                    <option value="Piotr Paku≈Ça|M">Piotr Paku≈Ça</option>
                    <option value="Wiktoria Nojek|F">Wiktoria Nojek</option>
                    <option value="Wojciech M≈Çynarczyk|M">Wojciech M≈Çynarczyk</option>
                    <option value="Maja Ziƒôba|F">Maja Ziƒôba</option>
                    <option value="Mateusz Dzidkowski|M">Mateusz Dzidkowski</option>
                </select>
            </div>
        </div>
        
        <div class="form-group">
            <label>Rodzaj Finansowania</label>
            <div style="display: flex; gap: 10px;">
                <select id="financingType" style="flex: 1;" onchange="toggleCustomFinancing()">
                    <optgroup label="Firmowe">
                        <option value="Kredyt firmowy ratalny" class="firmowe">Kredyt firmowy ratalny</option>
                        <option value="Kredyt w rachunku bie≈ºƒÖcym" class="firmowe">KRB (Kredyt w rachunku bie≈ºƒÖcym)</option>
                    </optgroup>
                    <optgroup label="Prywatne">
                        <option value="Kredyt got√≥wkowy" class="prywatne">Kredyt got√≥wkowy (prywatny)</option>
                        <option value="Limit odnawialny" class="prywatne">Limit odnawialny (prywatny)</option>
                    </optgroup>
                    <option value="Inne" style="font-weight: bold;">Inne (wpisz w≈Çasny...)</option>
                </select>
                <input type="text" id="customFinancingInput" placeholder="Wpisz nazwƒô finansowania..." style="display: none; flex: 1;">
            </div>
        </div>

        <div class="form-group"><label>Tre≈õƒá maila</label><textarea id="introText" rows="3"></textarea></div>

        <div class="header-with-toggle" style="margin-top: 30px;">
            <h2>2. Warianty Finansowania</h2>
            <button id="addVariantBtn" class="btn-add" style="width: auto; margin:0; padding: 8px 15px;" onclick="addVariant()">+ DODAJ WARIANT</button>
        </div>

        <div id="variantsContainer" class="row"></div>

        <div class="header-with-toggle">
            <h2>3. Edycja Tre≈õci Sta≈Çych</h2>
        </div>
        <div class="row" style="flex-wrap: wrap;">
            <div class="col form-group">
                <label>Nag≈Ç√≥wek: Korzy≈õci</label>
                <input type="text" id="headerBenefits" value="Kluczowe Korzy≈õci">
            </div>
            <div class="col form-group">
                <label>Nag≈Ç√≥wek: Wynagrodzenie</label>
                <input type="text" id="headerFee" value="Wynagrodzenie za Doradztwo">
            </div>
        </div>
        <div class="form-group">
            <label>Tekst ko≈Ñcowy (Stopka)</label>
            <textarea id="footerText" rows="2">Czekam na [GENDER] decyzjƒô odno≈õnie wyboru wariantu, aby≈õmy mogli sprawnie przej≈õƒá do procesowania wniosku.</textarea>
            <small style="color: #777; font-size: 12px;">U≈ºyj znacznika <b>[GENDER]</b>, aby automat wstawi≈Ç "Pana" lub "Pani" w zale≈ºno≈õci od wybranej p≈Çci.</small>
        </div>

        <div class="header-with-toggle">
            <h2>4. Wynagrodzenie i Opcje</h2>
            <div class="input-with-check">
                <input type="checkbox" id="check_fee_visibility" class="eye-checkbox" checked>
                <label for="check_fee_visibility" class="eye-label" title="Poka≈º/Ukryj ca≈ÇƒÖ sekcjƒô wynagrodzenia"></label>
            </div>
        </div>
        
        <div class="row" style="flex-wrap: wrap;">
            <div class="col form-group"><label>Success Fee (%)</label><input type="number" step="0.1" id="successFeeProc" value="4.0" oninput="updateCalculations()"></div>
            <div class="col form-group"><label>VAT</label><select id="vatType"><option value="VAT">+ VAT</option><option value="ZW">zw. z VAT</option></select></div>
            <div class="col form-group"><label>Kwota Fee</label><input type="text" id="successFeeKwota" title="Domy≈õlnie wyliczana od Kwoty Netto Wariantu I (Mo≈ºesz edytowaƒá rƒôcznie, je≈õli chcesz innƒÖ)"></div>
        </div>

        <h2>5. Korzy≈õci</h2>
        <div id="defaultBenefits">
            <div class="toggle-section" style="background:white; border-color:#eee;"><label><input type="checkbox" id="ben1" checked data-icon="wallet" onchange="refreshIcons()"> BRAK OP≈ÅAT KWARTALNYCH!</label></div>
            <div class="toggle-section" style="background:white; border-color:#eee;"><label><input type="checkbox" id="ben2" checked data-icon="ok" onchange="refreshIcons()"> Przejrzyste warunki</label></div>
            <div class="toggle-section" style="background:white; border-color:#eee;"><label><input type="checkbox" id="ben3" checked data-icon="unlock" onchange="refreshIcons()"> Pe≈Çna elastyczno≈õƒá (nadp≈Çata 0%)</label></div>
        </div>

        <div class="form-group" style="background: #f8faff; padding: 15px; border-radius: 6px; border: 1px solid #e1e4e8;">
            <label>Dodaj nowƒÖ korzy≈õƒá (Pogrubione automatycznie)</label>
            <input type="text" id="customBenText" placeholder="Wpisz tre≈õƒá...">
            
            <div style="margin-top: 10px; font-size: 14px; color:#555;">Wybierz ikonƒô (Wykorzystane standardowe ikony sƒÖ blokowane. <b>Ikona Checkboxa jest wielokrotnego u≈ºytku!</b>):</div>
            <div class="icon-selector" id="iconSelector"></div>
            <input type="hidden" id="selectedCustomIcon" value="">

            <button type="button" class="btn-add" onclick="addCustomBenefit()">+ DODAJ KORZY≈öƒÜ</button>
        </div>
        <div id="addedBenefitsList"></div>

        <div style="display: flex; gap: 15px; margin-top: 30px;">
            <button class="generate-btn" style="background-color: #6c757d; flex: 1;" onclick="generateOffer(true)">üëÅÔ∏è PODGLƒÑD</button>
            <button class="generate-btn" style="flex: 2;" onclick="generateOffer(false)">GENERUJ I PRZEJD≈π</button>
        </div>
    </div>

    <div class="sidebar">
        <div class="info-container">
            <div class="info-header">Stawki Referencyjne</div>
            <div class="info-date" id="current-date-wibor">≈Åadowanie...</div>
            <div class="rates-grid">
                <div class="rate-item"><p>WIBOR 1M</p><p class="value" id="wibor-1m">-</p></div>
                <div class="rate-item"><p>WIBOR 3M</p><p class="value" id="wibor-3m">-</p></div>
                <div class="rate-item"><p>WIBOR 6M</p><p class="value" id="wibor-6m">-</p></div>
            </div>
            <p class="disclaimer-text">Dane przedstawiajƒÖ warto≈õci z podanego dnia i aktualizowane sƒÖ systemowo.</p>
        </div>
        <div class="info-container info-container-single">
            <div class="info-header">Odsetki ustawowe</div>
            <div class="info-date" id="current-date-odsetki">≈Åadowanie...</div>
            <p class="value" id="odsetki-opoznienie">-</p>
        </div>
    </div>
</div>

<script>
    // --- POMOCNICZE FUNKCJE ---
    function parseMoney(val) { return parseFloat(val.toString().replace(/\s/g, '').replace('PLN','').replace(',','.')) || 0; }
    function formatMoney(num) { return num.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, ' ') + ' PLN'; }
    function calculatePMT(rate, periods, pv) {
        if (rate === 0) return pv / periods;
        const r = (rate / 100) / 12;
        return pv * r * Math.pow(1 + r, periods) / (Math.pow(1 + r, periods) - 1);
    }

    // --- DYNAMICZNE WARIANTY ---
    let variantsCount = 0;
    let totalVariantsCreated = 0;
    const maxVariants = 5;
    const variantColors = ['#007bff', '#17a2b8', '#28a745', '#fd7e14', '#6f42c1'];
    const romanNumerals = ['I', 'II', 'III', 'IV', 'V'];

    const defaultConditionText = `Konsolidacja obecnego kredytu\nLUB\nWnioskowanie dodatkowo o kredyt w rachunku bie≈ºƒÖcym na jednym wniosku (kwota mo≈ºliwa do pozyskania do 200 000 PLN - wnioskujemy o minimum 10 000 PLN limitu).`;

    function initVariants() {
        document.getElementById('variantsContainer').innerHTML = '';
        variantsCount = 0;
        totalVariantsCreated = 0;
        addVariant(); // Pierwszy wariant na start
    }

    function addVariant() {
        if (variantsCount >= maxVariants) return;
        variantsCount++;
        totalVariantsCreated++;
        const id = totalVariantsCreated; 
        const color = variantColors[variantsCount - 1];
        const roman = romanNumerals[variantsCount - 1];

        const html = `
        <div class="col variant-col" id="col_v${id}" data-vindex="${variantsCount}" style="border-top: 4px solid ${color}; background: #fdfdfd; padding: 15px; border-radius: 4px; border-left: 1px solid #eee; border-right: 1px solid #eee; border-bottom: 1px solid #eee;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 15px;">
                <h3 style="color: ${color}; margin:0;" class="variant-header">Wariant ${roman}</h3>
                ${variantsCount > 1 ? `<button type="button" class="btn-remove-var" onclick="removeVariant(${id})">X Usu≈Ñ</button>` : ''}
            </div>
            
            <div class="form-group" style="background: #f4f8fc; padding: 10px; border-radius: 6px; border: 1px solid #dcebf7;">
                <label>Okres (mies.)</label>
                <div class="input-with-check">
                    <input type="checkbox" id="check_v${id}_okres" class="eye-checkbox" checked>
                    <label for="check_v${id}_okres" class="eye-label"></label>
                    <input type="number" id="v${id}_months" value="120" oninput="updateCalculations()">
                </div>
                
                <label style="margin-top:10px;">Kwota Netto (PLN)</label>
                <div class="input-with-check">
                    <input type="checkbox" id="check_v${id}_netto" class="eye-checkbox" checked>
                    <label for="check_v${id}_netto" class="eye-label"></label>
                    <input type="text" id="v${id}_loanAmount" value="100 000" oninput="updateCalculations()" onblur="this.value=formatMoney(parseMoney(this.value)); updateCalculations();">
                </div>
            </div>

            <div class="form-group">
                <label>Kwota do dyspozycji</label>
                <div class="input-with-check">
                    <input type="checkbox" id="check_v${id}_dyspozycja" class="eye-checkbox" checked>
                    <label for="check_v${id}_dyspozycja" class="eye-label" title="Netto - Success Fee"></label>
                    <input type="text" id="v${id}_dyspozycja_display" readonly style="color:#0056b3; font-weight:bold;">
                </div>
            </div>

            <div class="form-group">
                <label>Kwota Brutto</label>
                <div class="input-with-check"><input type="checkbox" id="check_v${id}_brutto" class="eye-checkbox" checked><label for="check_v${id}_brutto" class="eye-label"></label><input type="text" id="v${id}_brutto_display" readonly></div>
            </div>
            <div class="form-group">
                <label>Prowizja (%)</label>
                <div class="input-with-check"><input type="checkbox" id="check_v${id}_prowizja" class="eye-checkbox" checked><label for="check_v${id}_prowizja" class="eye-label"></label><input type="number" step="0.01" id="v${id}_prowizja_proc" value="${variantsCount === 1 ? '2.5' : '0'}" oninput="updateCalculations()"></div>
            </div>
            <div class="form-group">
                <label>Mar≈ºa (%)</label>
                <div class="input-with-check"><input type="checkbox" id="check_v${id}_marza" class="eye-checkbox" checked><label for="check_v${id}_marza" class="eye-label"></label><input type="number" step="0.01" id="v${id}_marza" value="2.5" oninput="updateCalculations()"></div>
            </div>
            <div class="form-group">
                <label>WIBOR (%)</label>
                <div class="input-with-check">
                    <input type="checkbox" id="check_v${id}_wibor" class="eye-checkbox" checked>
                    <label for="check_v${id}_wibor" class="eye-label"></label>
                    <input type="number" step="0.01" id="v${id}_wibor_val" value="4.02" oninput="updateCalculations()">
                </div>
            </div>
            <hr style="border-top: 1px solid #eee;">
            <div class="form-group">
                <label>Oprocentowanie</label>
                <div class="input-with-check"><input type="checkbox" id="check_v${id}_oproc" class="eye-checkbox" checked><label for="check_v${id}_oproc" class="eye-label"></label><input type="text" id="v${id}_oproc_display" readonly></div>
            </div>
            <div class="form-group">
                <label>Koszt Ca≈Çkowity</label>
                <div class="input-with-check"><input type="checkbox" id="check_v${id}_koszt" class="eye-checkbox" checked><label for="check_v${id}_koszt" class="eye-label"></label><input type="text" id="v${id}_koszt_display" readonly style="color:#28a745; font-weight:bold;"></div>
            </div>
            <div class="form-group"><label>Rata</label><input type="text" id="v${id}_rata_display" readonly style="color: ${color}; font-weight:bold; font-size:16px;"></div>
            
            <hr style="border-top: 1px solid #ddd; margin-top:20px;">
            <div class="form-group" style="background: #f4f7f9; padding: 10px; border-radius: 6px;">
                <label style="color:#004d99; cursor:pointer; display:flex; align-items:center; gap:8px;">
                    <input type="checkbox" id="v${id}_has_condition" onchange="toggleCondition(${id})"> <strong>Dodaj pole z warunkiem</strong>
                </label>
                <div id="v${id}_condition_box" style="display:none; margin-top:10px;">
                    <input type="text" id="v${id}_cond_header" value="Warunek uzyskania wariantu:" placeholder="Nag≈Ç√≥wek warunku" style="margin-bottom:8px; font-weight:bold;">
                    <textarea id="v${id}_cond_text" rows="5" placeholder="Wpisz tre≈õƒá warunku...">${defaultConditionText}</textarea>
                </div>
            </div>
            
            <div class="form-group" style="background: #e6f7ff; padding: 10px; border-radius: 6px; border: 1px solid #b8daff; margin-top: 10px;">
                <label style="color:#004085; cursor:pointer; display:flex; align-items:center; gap:8px; margin:0;">
                    <input type="checkbox" id="v${id}_has_bgk"> <strong>Dodaj Gwarancjƒô BGK dla wariantu</strong>
                </label>
            </div>
        </div>`;
        
        document.getElementById('variantsContainer').insertAdjacentHTML('beforeend', html);
        updateAddButtonState();
        updateCalculations();
        recolorVariants();
    }

    function removeVariant(id) {
        document.getElementById(`col_v${id}`).remove();
        variantsCount--;
        updateAddButtonState();
        recolorVariants();
        updateCalculations();
    }

    function recolorVariants() {
        const cols = document.querySelectorAll('.variant-col');
        cols.forEach((col, index) => {
            const trueIndex = index + 1;
            const color = variantColors[trueIndex - 1];
            const roman = romanNumerals[trueIndex - 1];
            col.dataset.vindex = trueIndex;
            col.style.borderTopColor = color;
            col.querySelector('.variant-header').style.color = color;
            col.querySelector('.variant-header').textContent = `Wariant ${roman}`;
            col.querySelector('[id$="_rata_display"]').style.color = color;
        });
    }

    function updateAddButtonState() {
        const btn = document.getElementById('addVariantBtn');
        if (variantsCount >= maxVariants) { btn.style.display = 'none'; } else { btn.style.display = 'block'; }
    }

    function toggleCondition(id) {
        const box = document.getElementById(`v${id}_condition_box`);
        box.style.display = document.getElementById(`v${id}_has_condition`).checked ? 'block' : 'none';
    }

    // --- IKONY KORZY≈öCI ---
    const iconsDB = {
        'wallet': 'https://img.icons8.com/ios/50/0056b3/wallet--v1.png',
        'ok': 'https://img.icons8.com/ios/50/0056b3/ok--v1.png',
        'checkbox': 'https://img.icons8.com/ios/50/0056b3/checked-checkbox--v1.png',
        'unlock': 'https://img.icons8.com/ios/50/0056b3/unlock.png',
        'discount': 'https://img.icons8.com/ios/50/0056b3/discount--v1.png',
        'idea': 'https://img.icons8.com/ios/50/0056b3/idea.png',
        'star': 'https://img.icons8.com/ios/50/0056b3/star.png',
        'time': 'https://img.icons8.com/ios/50/0056b3/time.png',
        'rocket': 'https://img.icons8.com/ios/50/0056b3/rocket.png',
        'handshake': 'https://img.icons8.com/ios/50/0056b3/handshake.png',
        'money': 'https://img.icons8.com/ios/50/0056b3/money-circulation.png'
    };
    let customBenefits = [];

    function initIcons() {
        const selector = document.getElementById('iconSelector');
        selector.innerHTML = '';
        for (const [key, url] of Object.entries(iconsDB)) {
            const div = document.createElement('div');
            div.className = 'icon-opt';
            div.dataset.icon = key;
            if(key === 'checkbox') div.title = "Ikona wielokrotnego u≈ºytku";
            div.onclick = () => selectIcon(div);
            div.innerHTML = `<img src="${url}">`;
            selector.appendChild(div);
        }
    }
    function selectIcon(el) {
        if(el.classList.contains('disabled')) return;
        document.querySelectorAll('.icon-opt').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('selectedCustomIcon').value = el.dataset.icon;
    }
    function refreshIcons() {
        const usedIcons = new Set();
        document.querySelectorAll('#defaultBenefits input[type="checkbox"]').forEach(chk => { if(chk.checked) usedIcons.add(chk.dataset.icon); });
        customBenefits.forEach(ben => usedIcons.add(ben.icon));
        
        document.querySelectorAll('.icon-opt').forEach(opt => {
            if(usedIcons.has(opt.dataset.icon) && opt.dataset.icon !== 'checkbox') { 
                opt.classList.add('disabled'); 
                opt.classList.remove('active'); 
            } else { 
                opt.classList.remove('disabled'); 
            }
        });
    }

    function toggleCustomFinancing() {
        const select = document.getElementById('financingType');
        const input = document.getElementById('customFinancingInput');
        if (select.value === 'Inne') { input.style.display = 'block'; input.focus(); } else { input.style.display = 'none'; }
    }

    function updateIntroText() {
        const genderAdv = document.getElementById('advisor').value.split('|')[1];
        let t_anal = genderAdv === 'F' ? 'Przeanalizowa≈Çam' : 'Przeanalizowa≈Çem';
        let t_prep = genderAdv === 'F' ? 'przygotowa≈Çam' : 'przygotowa≈Çem';
        let t_ment = genderAdv === 'F' ? 'wspomina≈Çam' : 'wspomina≈Çem';
        document.getElementById('introText').value = `w nawiƒÖzaniu do rozmowy przesy≈Çam kalkulacje propozycji finansowania. ${t_anal} dostƒôpne mo≈ºliwo≈õci i ${t_prep} ofertƒô kredytu, o kt√≥rym ju≈º ${t_ment} telefonicznie, przygotowanƒÖ w wariantach r√≥≈ºniƒÖcych siƒô parametrami poczƒÖtkowymi.`;
    }
    document.getElementById('advisor').addEventListener('change', updateIntroText);

    function addCustomBenefit() {
        const text = document.getElementById('customBenText').value;
        const icon = document.getElementById('selectedCustomIcon').value;
        if(text.trim() === '' || icon === '') return alert('Uzupe≈Çnij tekst i wybierz ikonƒô z listy!');
        let finalText = text;
        if(!finalText.includes('<b>') && !finalText.includes('<strong>')) finalText = '<strong>' + finalText + '</strong>';
        customBenefits.push({ text: finalText, icon: icon });
        renderCustomBenefits();
        document.getElementById('customBenText').value = '';
        document.getElementById('selectedCustomIcon').value = '';
        document.querySelectorAll('.icon-opt').forEach(i => i.classList.remove('active'));
        refreshIcons();
    }
    function removeCustomBenefit(index) { customBenefits.splice(index, 1); renderCustomBenefits(); refreshIcons(); }
    function renderCustomBenefits() {
        const list = document.getElementById('addedBenefitsList'); list.innerHTML = '';
        customBenefits.forEach((ben, index) => {
            const div = document.createElement('div'); div.className = 'added-benefit-item';
            div.innerHTML = `<div style="display:flex;align-items:center;"><img src="${iconsDB[ben.icon]}"><span>${ben.text}</span></div><span class="remove-ben-btn" onclick="removeCustomBenefit(${index})">&times;</span>`;
            list.appendChild(div);
        });
    }

    function updateCalculations() {
        const successFeeProc = parseFloat(document.getElementById('successFeeProc').value) || 0;
        let firstVariantNetto = 0;

        const variantCols = document.querySelectorAll('.variant-col');
        
        if(variantCols.length > 0) {
            const firstId = variantCols[0].id.replace('col_v', '');
            firstVariantNetto = parseMoney(document.getElementById(`v${firstId}_loanAmount`).value);
        }

        const feeInput = document.getElementById('successFeeKwota');
        if (feeInput.value === '' || feeInput.dataset.auto === "true" || feeInput.dataset.auto === undefined) {
            feeInput.value = formatMoney(firstVariantNetto * (successFeeProc / 100));
            feeInput.dataset.auto = "true";
        }

        const finalFee = parseMoney(feeInput.value);

        variantCols.forEach((col, index) => {
            const id = col.id.replace('col_v', '');
            
            const loanAmountEl = document.getElementById(`v${id}_loanAmount`);
            const monthsEl = document.getElementById(`v${id}_months`);
            const prowizjaEl = document.getElementById(`v${id}_prowizja_proc`);
            const marzaEl = document.getElementById(`v${id}_marza`);
            const wiborEl = document.getElementById(`v${id}_wibor_val`);
            
            if(!loanAmountEl || !marzaEl || !wiborEl) return;

            const loanNetto = parseMoney(loanAmountEl.value);
            const months = parseInt(monthsEl.value) || 120;
            const p = parseFloat(prowizjaEl.value) || 0;
            const m = parseFloat(marzaEl.value) || 0;
            const w = parseFloat(wiborEl.value) || 0;

            const calc_brutto = loanNetto * (1 + p/100);
            const rate = w + m;
            const rata = calculatePMT(rate, months, calc_brutto);
            const koszt = (rata * months) - loanNetto;
            const dyspozycja = loanNetto - finalFee;

            if(document.getElementById(`v${id}_dyspozycja_display`)) {
                document.getElementById(`v${id}_dyspozycja_display`).value = formatMoney(dyspozycja);
            }

            document.getElementById(`v${id}_brutto_display`).value = formatMoney(calc_brutto);
            document.getElementById(`v${id}_oproc_display`).value = rate.toFixed(2) + '%';
            document.getElementById(`v${id}_rata_display`).value = formatMoney(rata);
            document.getElementById(`v${id}_koszt_display`).value = formatMoney(koszt);
        });
    }
    
    document.getElementById('successFeeKwota').addEventListener('input', function() {
        this.dataset.auto = "false";
        updateCalculations();
    });

    // --- GENERUJ ---
    function generateOffer(isPreview = false) {
        let selectedFinancing = document.getElementById('financingType').value;
        if (selectedFinancing === 'Inne') { selectedFinancing = document.getElementById('customFinancingInput').value; }

        const advisorVal = document.getElementById('advisor').value; 
        const advisorName = advisorVal.split('|')[0];
        const advisorLinks = {
            "Dawid B≈Çachno": "https://q-r.to/DawidBlachnoBiuroBAF",
            "Weronika Lekston": "https://q-r.to/WeronikaLekstonBiuroBAF",
            "Mieczys≈Çaw Andrzejewski": "https://l.ead.me/MieczyslawAndrzejewskiBiuroBAF",
            "Joanna Karpa≈Ça": "https://l.ead.me/JoannaKarpalaBiuroBAF",
            "Piotr Paku≈Ça": "https://q-r.to/PakulaPiotrBiuroBAF",
            "Wiktoria Nojek": "https://q-r.to/WiktoraNojekBiuroBAF",
            "Wojciech M≈Çynarczyk": "https://q-r.to/WojciechMlynarczykBiuroBAF",
            "Maja Ziƒôba": "https://q-r.to/MajaZiebaBiuroBAF",
            "Mateusz Dzidkowski": "https://q-r.to/MateuszDzidkowskiBiuroBAF"
        };

        const genderVal = document.getElementById('clientGender').value;
        const finalFooter = document.getElementById('footerText').value.replace('[GENDER]', genderVal === 'F' ? 'Pani' : 'Pana');

        const data = {
            clientName: document.getElementById('clientName').value,
            clientGender: document.getElementById('clientGender').value,
            advisorData: advisorVal,
            advisorLink: advisorLinks[advisorName] || "",
            financingType: selectedFinancing,
            introText: document.getElementById('introText').value,
            vatType: document.getElementById('vatType').value,
            
            customHeaders: { benefits: document.getElementById('headerBenefits').value, fee: document.getElementById('headerFee').value },
            closingText: finalFooter,
            visibility: { feeSection: document.getElementById('check_fee_visibility').checked },
            feeProc: document.getElementById('successFeeProc').value + '%',
            feeKwota: document.getElementById('successFeeKwota').value,
            variants: [],
            benefits: []
        };

        const cols = document.querySelectorAll('.variant-col');
        cols.forEach((col) => {
            const id = col.id.replace('col_v', '');
            const vIndex = parseInt(col.dataset.vindex);
            const color = variantColors[vIndex-1];
            const roman = romanNumerals[vIndex-1];
            
            let finalNettoText = document.getElementById(`v${id}_loanAmount`).value;
            if(!finalNettoText.includes('PLN')) finalNettoText = formatMoney(parseMoney(finalNettoText));

            data.variants.push({
                color: color,
                roman: roman,
                months: document.getElementById(`v${id}_months`).value,
                netto: finalNettoText,
                dyspozycja: document.getElementById(`v${id}_dyspozycja_display`).value,
                brutto: document.getElementById(`v${id}_brutto_display`).value,
                prowizja: document.getElementById(`v${id}_prowizja_proc`).value + '%',
                marza: document.getElementById(`v${id}_marza`).value + '%',
                wibor: document.getElementById(`v${id}_wibor_val`).value + '%',
                oproc: document.getElementById(`v${id}_oproc_display`).value,
                rata: document.getElementById(`v${id}_rata_display`).value,
                koszt: document.getElementById(`v${id}_koszt_display`).value,
                
                hasCondition: document.getElementById(`v${id}_has_condition`).checked,
                condHeader: document.getElementById(`v${id}_cond_header`).value,
                condText: document.getElementById(`v${id}_cond_text`).value,
                
                hasBgk: document.getElementById(`v${id}_has_bgk`).checked,

                visibility: {
                    okres: document.getElementById(`check_v${id}_okres`).checked,
                    netto: document.getElementById(`check_v${id}_netto`).checked,
                    dyspozycja: document.getElementById(`check_v${id}_dyspozycja`).checked,
                    brutto: document.getElementById(`check_v${id}_brutto`).checked,
                    prowizja: document.getElementById(`check_v${id}_prowizja`).checked,
                    marza: document.getElementById(`check_v${id}_marza`).checked,
                    wibor: document.getElementById(`check_v${id}_wibor`).checked,
                    oproc: document.getElementById(`check_v${id}_oproc`).checked,
                    koszt: document.getElementById(`check_v${id}_koszt`).checked
                }
            });
        });

        // Korzy≈õci
        const defaultTexts = {
            'ben1': '<strong>BRAK OP≈ÅAT KWARTALNYCH!</strong> Nie ma ≈ºadnych ukrytych koszt√≥w za utrzymanie finansowania.',
            'ben2': '<strong>Przejrzyste warunki:</strong> Umowa bez "gwiazdek" i dodatkowych, nieoczekiwanych koszt√≥w.',
            'ben3': '<strong>Pe≈Çna elastyczno≈õƒá:</strong> Ca≈Çkowity brak op≈Çat za nadp≈Çatƒô oraz wcze≈õniejszƒÖ ca≈ÇkowitƒÖ sp≈Çatƒô kredytu.'
        };
        ['ben1','ben2','ben3'].forEach(id => {
            if(document.getElementById(id).checked) {
                data.benefits.push({ text: defaultTexts[id], icon: document.getElementById(id).dataset.icon });
            }
        });
        customBenefits.forEach(ben => data.benefits.push(ben));

        localStorage.setItem('bafOfferData_V5_4', JSON.stringify(data));
        
        if (isPreview) { window.open('oferta.html', '_blank'); } else { window.location.href = 'oferta.html'; }
    }

    // Inicjalizacja
    initIcons(); updateIntroText(); initVariants(); refreshIcons();
</script>

<script>
    // BAF AUTO UPDATE
    try {
        document.getElementById('wibor-1m').textContent = '3,98%';
        document.getElementById('wibor-3m').textContent = '3,87%';
        document.getElementById('wibor-6m').textContent = '3,76%';
        document.getElementById('odsetki-opoznienie').textContent = '9,5%';
        
        const dzisiaj = 'Dane na dzie≈Ñ: 19.02.2026';
        if(document.getElementById('current-date-wibor')) document.getElementById('current-date-wibor').textContent = dzisiaj;
        if(document.getElementById('current-date-odsetki')) document.getElementById('current-date-odsetki').textContent = dzisiaj;

        const startWibor = '4.02';
        document.querySelectorAll('input[id$="_wibor_val"]').forEach(el => el.value = startWibor);
        if(typeof updateCalculations === 'function') updateCalculations();
    } catch(e) { console.log('Brak elementu w tym pliku'); }
</script>
</body>
</html>
